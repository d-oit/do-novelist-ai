---
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  # Security: Dependency Review (GitHub Official)
  dependency-review:
    name: ğŸ”’ Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Unlicense, CC0-1.0

  # Security: CodeQL Analysis (GitHub Official SAST)
  codeql-analysis:
    name: ğŸ” CodeQL Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality,security-extended
          config-file: .github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  # Build and Test
  build-and-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Add pnpm to PATH
        run: |
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> "$GITHUB_ENV"

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm run lint

      - name: Run tests
        run: pnpm test

      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            dist
          key: >-
            ${{ runner.os }}-vite-${{ hashFiles('src/**', 'vite.config.ts') }}

      - name: Build
        run: pnpm run build

      - name: Generate build manifest
        run: |
          cat > dist/build-manifest.json << EOF
          {
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: dist/
          retention-days: 7
          compression-level: 9

  # E2E Tests (Separate job with enhanced caching and retries)
  e2e-tests:
    name: ğŸ§ª E2E Tests [Shard ${{ matrix.shard }}/3]
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: build-and-test
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Add pnpm to PATH
        run: |
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> "$GITHUB_ENV"

      - name: Install system dependencies for Playwright
        run: |
          # Install additional system dependencies for browser stability
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 \
            libx11-xcb1 \
            libxcb1 \
            libxcomposite1 \
            libxcursor1 \
            libxdamage1 \
            libxext6 \
            libxfixes3 \
            libxi6 \
            libxrandr2 \
            libxrender1 \
            libxss1 \
            libxtst6 \
            libnss3 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libgbm1 \
            libgtk-3-0 \
            libxshmfence1 \
            ca-certificates \
            fonts-liberation \
            wget

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: |
            ~/.cache/ms-playwright
            ~/.cache/ms-playwright/chromium-*
            ~/.cache/ms-playwright/firefox-*
            ~/.cache/ms-playwright/webkit-*
          key: >-
            ${{ runner.os }}-playwright-browsers-${{
              hashFiles('**/pnpm-lock.yaml', 'package.json')
            }}-${{ matrix.shard }}
          restore-keys: |
            ${{ runner.os }}-playwright-browsers-${{
              hashFiles('**/pnpm-lock.yaml', 'package.json') }}-
            ${{ runner.os }}-playwright-browsers-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers with system dependencies
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: |
          # Install Playwright browsers with all system dependencies
          pnpm exec playwright install --with-deps chromium
          echo "âœ… Playwright browsers installed successfully"

      - name: Verify Playwright installation
        run: |
          echo "ğŸ” Verifying Playwright installation..."
          pnpm exec playwright --version
          echo "ğŸ“¦ Browsers cache:"
          ls -la ~/.cache/ms-playwright/ 2>/dev/null ||
          echo "No browser cache found"

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: dist/

      - name: Run Playwright tests with enhanced debugging
        run: |
          echo "ğŸ§ª Starting E2E tests for shard ${{ matrix.shard }}/3"
          echo "ğŸ“‹ Test configuration:"
          echo "  - Workers: 1 (to avoid conflicts with sharding)"
          echo "  - Retries: 2 (for CI stability)"
          echo "  - Timeout: 90s per test"
          echo "  - CI Mode: Enabled"

          # Create test results directory
          mkdir -p test-results playwright-report

          # Set enhanced environment variables for CI stability
          export CI=true
          export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright
          export DEBUG=pw:browser
          export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=0
          export NODE_ENV=test
          export GITHUB_SHA=${{ github.sha }}

          # Run tests with automatic retries and better error reporting
          timeout 2400 pnpm exec playwright test \
            --shard=${{ matrix.shard }}/3 \
            --workers=1 \
            --reporter=list,junit,json \
            --output=test-results \
            --max-failures=5 \
            || {
              echo "âŒ Tests failed or timed out"
              echo "ğŸ“Š Collecting debug information..."
              echo "ğŸ Browser processes:"
              pgrep -fa "(chromium|firefox|webkit)" ||
              echo "No browser processes found"
              echo "ğŸ’¾ Disk space:"
              df -h
              echo "ğŸ§  Memory usage:"
              free -h
              echo "ğŸ“ Playwright cache contents:"
              ls -la ~/.cache/ms-playwright/ 2>/dev/null ||
              echo "No cache directory"
              echo "ğŸ“ Test results directory:"
              ls -la test-results/ 2>/dev/null || echo "No test results"
              echo "ğŸ“ Playwright report directory:"
              ls -la playwright-report/ 2>/dev/null || echo "No report directory"
              exit 1
            }

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-shard-${{ matrix.shard }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 14

      - name: Upload test results summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-summary-shard-${{ matrix.shard }}-${{ github.sha }}
          path: |
            test-results/results.json
            test-results/junit.xml
          retention-days: 7

      - name: Verify test results were generated
        if: always()
        run: |
          echo "ğŸ” Verifying test result files..."
          if [ -f "test-results/results.json" ]; then
            echo "âœ… results.json found"
            echo "ğŸ“Š Test summary:"
            cat test-results/results.json | head -50
          else
            echo "âŒ results.json not found"
          fi

          if [ -f "test-results/junit.xml" ]; then
            echo "âœ… junit.xml found"
            echo "ğŸ“‹ JUnit summary:"
            grep -E "(tests|failures|time)" test-results/junit.xml | head -10
          else
            echo "âŒ junit.xml not found"
          fi

  # Deployment gate (only for main branch)
  deployment-gate:
    name: ğŸš¦ Deployment Gate
    runs-on: ubuntu-latest
    needs: [dependency-review, codeql-analysis, build-and-test, e2e-tests]
    if: |
      always() &&
      (needs.build-and-test.result == 'success') &&
      (needs.codeql-analysis.result == 'success') &&
      (needs.dependency-review.result == 'success' ||
       needs.dependency-review.result == 'skipped') &&
      (github.event_name == 'pull_request' ||
       needs.e2e-tests.result == 'success') &&
      github.ref == 'refs/heads/main'
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build-${{ github.sha }}
          path: dist/

      - name: Verify build manifest
        run: |
          echo "âœ… All checks passed. Ready for deployment."
          if [ -f dist/build-manifest.json ]; then
            cat dist/build-manifest.json
          fi
