---
name: Enhanced CI with Performance Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1

jobs:
  # Quality gates that must pass before performance testing
  quality-gates:
    name: Quality Gates & Fast Tests
    runs-on: ubuntu-latest

    outputs:
      should-run-performance: ${{ steps.changes.outputs.should-run }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint and type check
        run: pnpm run lint:ci

      - name: Unit tests with coverage
        run: |
          pnpm run coverage
          # Check coverage thresholds
          COVERAGE=$(grep -o '"pct":[0-9.]*' coverage/coverage-summary.json | head -1 | cut -d':' -f2)
          if (( $(echo "$COVERAGE < 80" | bc -l) )); then
            echo "âŒ Coverage below 80%: $COVERAGE%"
            exit 1
          fi
          echo "âœ… Coverage: $COVERAGE%"

      - name: Accessibility unit tests
        run: pnpm run test -- src/test/accessibility-audit.test.ts

      - name: Check for performance-impacting changes
        id: changes
        run: |
          # Check if changes might impact performance
          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          if git diff --name-only "$BEFORE" "$SHA" | \
            grep -E '\.(tsx?|jsx?|css|scss)$|vite\.config|package\.json'; then
            echo "should-run=true" >> "$GITHUB_OUTPUT"
            echo "Performance-impacting changes detected"
          else
            echo "should-run=false" >> "$GITHUB_OUTPUT"
            echo "No performance-impacting changes detected"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: coverage/
          retention-days: 30

  # Fast performance check for PRs
  quick-performance-check:
    name: Quick Performance Check
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.event_name == 'pull_request' && needs.quality-gates.outputs.should-run-performance == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Quick build analysis
        run: |
          pnpm run build

          # Quick size check
          TOTAL_SIZE=$(du -sb dist | cut -f1)
          TOTAL_SIZE_MB=$(echo "scale=2; $TOTAL_SIZE / 1048576" | bc)

          echo "Total build size: ${TOTAL_SIZE_MB}MB"

          if (( $(echo "$TOTAL_SIZE_MB > 5" | bc -l) )); then
            echo "âŒ Build size too large: ${TOTAL_SIZE_MB}MB > 5MB"
            exit 1
          fi

          echo "âœ… Build size acceptable: ${TOTAL_SIZE_MB}MB"

      - name: Quick E2E smoke test
        run: pnpm run test:e2e -- --project=chromium tests/specs/debug.spec.ts

  # Comprehensive performance testing for main branch
  comprehensive-performance:
    name: Comprehensive Performance Testing
    runs-on: ubuntu-latest
    needs: quality-gates
    if: github.ref == 'refs/heads/main' && needs.quality-gates.outputs.should-run-performance == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and analyze
        run: pnpm run analyze

      - name: Install Lighthouse CI
        run: pnpm add -g @lhci/cli@0.13.x

      - name: Run Lighthouse CI
        run: lhci autorun --config=lighthouserc.cjs --config=lighthouserc.js
        # env:
        #  LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Full E2E test suite
        run: pnpm run test:e2e

      - name: Performance metrics collection
        run: |
          # Extract key metrics from build
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          CHUNK_COUNT=$(find dist/assets -name '*.js' -type f | wc -l)

          {
            echo "## ðŸ“Š Performance Metrics"
            echo ""
            echo "### Bundle Analysis"
            find dist/assets -type f \( -name '*.js' -o -name '*.css' \) -exec ls -lah {} \; | head -10
            echo ""
            echo "- Total build size: $TOTAL_SIZE"
            echo "- JavaScript chunks: $CHUNK_COUNT"
            echo "- Generated: $(date)"
          } > performance-summary.md

      - name: Upload comprehensive results
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-performance-${{ github.sha }}
          path: |
            dist/stats.html
            .lighthouseci/
            performance-summary.md
            test-results/
          retention-days: 90

      - name: Update performance baseline
        run: |
          # Store performance metrics for future comparisons
          mkdir -p .performance-baseline
          echo "{
            \"timestamp\": \"$(date -Iseconds)\",
            \"commit\": \"${{ github.sha }}\",
            \"totalSize\": $(du -sb dist | cut -f1),
            \"chunkCount\": $(find dist/assets -name '*.js' -type f | wc -l)
          }" > .performance-baseline/latest.json

  # Security and dependency checks
  security-audit:
    name: Security & Dependency Audit
    runs-on: ubuntu-latest
    needs: quality-gates

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        run: |
          pnpm audit --audit-level=high

      - name: Check for vulnerable packages
        run: |
          # Check for known vulnerable packages
          pnpm audit --audit-level=high

      - name: Bundle analyzer security check
        run: |
          # Check for potentially sensitive data in bundles
          pnpm run build
          if grep -r "password\|secret\|key\|token" dist/ --exclude-dir=node_modules; then
            echo "âš ï¸ Potential sensitive data found in bundles"
            echo "Please review the above findings"
          else
            echo "âœ… No obvious sensitive data detected in bundles"
          fi

  # Performance notifications and reporting
  performance-reporting:
    name: Performance Reporting
    runs-on: ubuntu-latest
    needs: [quality-gates, comprehensive-performance]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Download performance artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: comprehensive-performance-*
          merge-multiple: true

      - name: Generate performance report
        run: |
          {
            echo "# ðŸš€ Performance Report - $(date)"
            echo ""
            if [ -f performance-summary.md ]; then
              cat performance-summary.md
            fi
            echo ""
            echo "## ðŸ”— Resources"
            echo "- [Bundle Analyzer](./stats.html)"
            echo "- [Lighthouse Report](./.lighthouseci/)"
            echo "- [Test Results](./test-results/)"
          } > performance-report.md

      - name: Comment performance summary
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        continue-on-error: true # Don't fail if no permission
        with:
          script: |
            // Create a commit comment with performance summary
            const fs = require('fs');
            if (fs.existsSync('performance-report.md')) {
              const report = fs.readFileSync('performance-report.md', 'utf8');

              await github.rest.repos.createCommitComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                commit_sha: context.sha,
                body: report
              });
            }
