---
name: Fast CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: "--max-old-space-size=4096"
  CI: true

jobs:
  # Quick validation and setup
  setup:
    name: ðŸš€ Quick Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      node-version: "20"
      pnpm-version: "9"
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

  # Fast lint check
  lint:
    name: ðŸ” ESLint Check
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Restore pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache ESLint
        uses: actions/cache@v5
        with:
          path: .eslintcache
          key: ${{ runner.os }}-eslint-${{ hashFiles('eslint.config.js', 'src/**/*.ts', 'src/**/*.tsx') }}

      - name: Run ESLint
        run: pnpm run lint:eslint

  # TypeScript type check
  typecheck:
    name: ðŸŸ¦ Type Check
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Restore pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Cache TypeScript build
        uses: actions/cache@v5
        with:
          path: "**/*.tsbuildinfo"
          key: ${{ runner.os }}-typescript-${{ hashFiles('tsconfig.json', 'src/**/*.ts', 'src/**/*.tsx') }}

      - name: Run TypeScript type check
        run: pnpm run lint:typecheck

  # Sharded Unit tests
  unit-tests:
    name: ðŸ§ª Unit Tests (Shard ${{ matrix.shard }}/3)
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Restore pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm run test -- --shard=${{ matrix.shard }}/3
  # Security Audit
  security:
    name: ðŸ›¡ï¸ Security Audit
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Run audit
        run: pnpm audit --prod
  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Restore pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check .env.example completeness
        run: pnpm run check:env-example

      - name: Check file sizes
        run: pnpm run check:file-size

      - name: Cache Vite build
        uses: actions/cache@v5
        with:
          path: |
            node_modules/.vite
            dist
          key: ${{ runner.os }}-vite-${{ hashFiles('src/**', 'vite.config.ts') }}

      - name: Build application
        run: pnpm run build
        env:
          VITE_OPENROUTER_API_KEY: test-openrouter-key
          VITE_DEFAULT_AI_PROVIDER: mistral
          VITE_DEFAULT_AI_MODEL: mistral:mistral-medium-latest
          VITE_TURSO_DATABASE_URL: test-url
          VITE_TURSO_AUTH_TOKEN: test-token
          VITE_DISABLE_AI_SDK: "true"
          DISABLE_AI_SDK: "true"

      - name: Verify build
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found"
            exit 1
          fi
          echo "âœ… Build completed successfully"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/
          retention-days: 7

  # Quick E2E test (single run for fast feedback)
  e2e-quick:
    name: ðŸŽ­ E2E Quick Test
    runs-on: ubuntu-latest
    needs: [build]
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 \
            libxss1 libxtst6 libnss3 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libgbm1 libgtk-3-0 libxshmfence1 \
            ca-certificates fonts-liberation wget

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v7
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Run quick E2E tests
        run: |
          echo "ðŸŽ­ Running quick E2E tests (smoke tests)"

          # Set environment
          export CI=true
          export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright
          export NODE_ENV=test

          # Run smoke tests for quick feedback (chromium only)
          # Tests critical user flows: navigation, settings, and accessibility
          pnpm exec playwright test \
            --project=chromium \
            --reporter=list,html \
            --grep="debug|project-management|settings" \
            --retries=2 \
            --timeout=30000 \
            --workers=2

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-quick-results-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

  # Summary
  summary:
    name: ðŸ“Š Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, unit-tests, security, build, e2e-quick]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          {
            echo "# âš¡ Fast CI Summary"
            echo ""
            echo "**Commit**: ${{ github.sha }}"
            echo "**Branch**: ${{ github.ref_name }}"
            echo "**Trigger**: ${{ github.event_name }}"
            echo ""
            echo "## ðŸŽ¯ Job Results"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Lint | ${{ needs.lint.result }} |"
            echo "| TypeCheck | ${{ needs.typecheck.result }} |"
            echo "| Unit Tests | ${{ needs.unit-tests.result }} |"
            echo "| Security | ${{ needs.security.result }} |"
            echo "| Build | ${{ needs.build.result }} |"
            echo "| E2E Quick | ${{ needs.e2e-quick.result }} |"
            echo ""

            # Overall status
            FAILED=0
            [ "${{ needs.lint.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.typecheck.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.unit-tests.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.security.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.build.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.e2e-quick.result }}" != "success" ] && FAILED=$((FAILED + 1))

            if [ "$FAILED" -eq 0 ]; then
              echo "## âœ… Status: PASSED"
              echo "Fast CI checks completed successfully!"
            else
              echo "## âŒ Status: FAILED"
              echo "$FAILED critical job(s) failed."
            fi
          } > fast-ci-summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v6
        with:
          name: fast-ci-summary-${{ github.sha }}
          path: fast-ci-summary.md
          retention-days: 7
