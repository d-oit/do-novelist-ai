---
name: Deployment Pipeline

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: "Deployment environment (staging, production)"
      artifact_name:
        required: true
        type: string
        description: "Name of the build artifact to deploy"
    secrets:
      DEPLOYMENT_TOKEN:
        required: false
        description: "Custom deployment token (optional)"

  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [staging, production]
        required: true
        description: "Environment to deploy to"
      force_deploy:
        type: boolean
        required: false
        default: false
        description: "Force deployment even if tests failed"

  repository_dispatch:
    types: [deployment-ready]

concurrency:
  group: deployment-${{ inputs.environment || github.event.inputs.environment }}
  cancel-in-progress: false

env:
  NODE_OPTIONS: "--max-old-space-size=4096"

jobs:
  pre-deployment-check:
    name: Pre-deployment Validation
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.validation.outputs.should_deploy }}
      build_artifact: ${{ steps.find-artifact.outputs.artifact_name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Validate environment
        id: validate
        run: |
          ENV="${{ inputs.environment || github.event.inputs.environment }}"
          echo "Validating deployment to: $ENV"

          case "$ENV" in
            staging|production)
              echo "[OK] Environment validation passed"
              ;;
            *)
              echo "[FAIL] Invalid environment: $ENV"
              echo "Must be one of: staging, production"
              exit 1
              ;;
          esac

      - name: Check deployment conditions
        id: validation
        run: |
          FORCE="${{ github.event.inputs.force_deploy }}"
          REF="${{ github.ref }}"

          # Check if this is from repository dispatch (CI pipeline)
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "[REFRESH] Deployment triggered by CI pipeline"
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            echo "[OK] CI pipeline deployment approved"
          elif [ "$FORCE" = "true" ]; then
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            echo "[FAST] Force deployment enabled"
          elif [ "$REF" != "refs/heads/main" ]; then
            echo "should_deploy=false" >> "$GITHUB_OUTPUT"
            echo "[FAIL] Only main branch can be deployed"
          else
            echo "should_deploy=true" >> "$GITHUB_OUTPUT"
            echo "[OK] Main branch deployment approved"
          fi

      - name: Find latest build artifact
        id: find-artifact
        run: |
          # Check client payload from repository dispatch
          if [ "${{ github.event_name }}" = "repository_dispatch" ] && \
             [ -n "${{ github.event.client_payload.build_artifact }}" ]; then
            ARTIFACT="${{ github.event.client_payload.build_artifact }}"
            echo "artifact_name=$ARTIFACT" >> "$GITHUB_OUTPUT"
            echo "[PACKAGE] Using artifact from CI payload: $ARTIFACT"
          elif [ -n "${{ inputs.artifact_name }}" ]; then
            echo "artifact_name=${{ inputs.artifact_name }}" >> "$GITHUB_OUTPUT"
            echo "[PACKAGE] Using provided artifact name: ${{ inputs.artifact_name }}"
          else
            # Try multiple possible artifact names
            echo "[SEARCH] Searching for build artifacts..."
            echo "artifact_name=build-artifacts-${{ github.sha }}" >> "$GITHUB_OUTPUT"
            echo "[PACKAGE] Using default artifact pattern: build-artifacts-${{ github.sha }}"
          fi

  download-artifacts:
    name: Download Build Artifacts
    runs-on: ubuntu-latest
    needs: pre-deployment-check
    if: needs.pre-deployment-check.outputs.should_deploy == 'true'
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        id: download-primary
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.pre-deployment-check.outputs.build_artifact }}
          path: dist/
        continue-on-error: true

      - name: Download alternative artifacts if primary fails
        if: steps.download-primary.outcome == 'failure'
        uses: actions/download-artifact@v4
        id: download-fallback
        with:
          name: production-build-${{ github.sha }}
          path: dist/

      - name: Verify artifacts
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "[FAIL] Build artifacts not found or invalid"
            echo " Contents of dist/:"
            ls -la dist/ 2>/dev/null || echo "dist/ directory does not exist"
            echo "[SEARCH] Available artifacts:"
            if command -v gh &> /dev/null; then
              gh api repos/${{ github.repository }}/actions/artifacts \
                --jq '.artifacts[] | select(.name | contains("build")) | "\(.name): \(.expired)"' \
                2>/dev/null || echo "Unable to list artifacts"
            fi
            exit 1
          fi

          # Check build manifest if available
          if [ -f "dist/build-manifest.json" ]; then
            echo "[LIST] Build manifest found:"
            cat dist/build-manifest.json
          fi

          echo "[OK] Build artifacts verified successfully"

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, download-artifacts]
    if: |
      needs.pre-deployment-check.outputs.should_deploy == 'true' &&
      (inputs.environment == 'staging' || github.event.inputs.environment == 'staging')
    environment:
      name: staging
      url: https://staging.novelist.ai

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.pre-deployment-check.outputs.build_artifact }}
          path: _site/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create deployment record
        run: |
          {
            echo "## [DEPLOY] Staging Deployment Complete"
            echo ""
            echo "- **Environment**: Staging"
            echo "- **Commit**: ${{ github.sha }}"
            echo "- **Deployed by**: ${{ github.actor }}"
            echo "- **URL**: ${{ steps.deployment.outputs.page_url }}"
            echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } > deployment-summary.md

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v5
        with:
          name: staging-deployment-${{ github.sha }}
          path: deployment-summary.md
          retention-days: 30

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [pre-deployment-check, download-artifacts]
    if: |
      needs.pre-deployment-check.outputs.should_deploy == 'true' &&
      (inputs.environment == 'production' || github.event.inputs.environment == 'production')
    environment:
      name: production
      url: https://novelist.ai

    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.pre-deployment-check.outputs.build_artifact }}
          path: _site/

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Create deployment record
        run: |
          {
            echo "## [DEPLOY] Production Deployment Complete"
            echo ""
            echo "- **Environment**: Production"
            echo "- **Commit**: ${{ github.sha }}"
            echo "- **Deployed by**: ${{ github.actor }}"
            echo "- **URL**: ${{ steps.deployment.outputs.page_url }}"
            echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          } > deployment-summary.md

      - name: Upload deployment artifacts
        uses: actions/upload-artifact@v5
        with:
          name: production-deployment-${{ github.sha }}
          path: deployment-summary.md
          retention-days: 90

  post-deployment:
    name: Post-deployment Validation
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always()

    steps:
      - name: Download deployment summaries
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Validate deployment
        run: |
          echo "## [LIST] Deployment Summary"
          echo ""
          cat deployment-summary.md 2>/dev/null || echo "No deployment summary found"
          echo ""
          echo "### Deployment Status:"
          echo "- Staging: ${{ needs.deploy-staging.result }}"
          echo "- Production: ${{ needs.deploy-production.result }}"

          if [ "${{ needs.deploy-staging.result }}" = "success" ] || \
             [ "${{ needs.deploy-production.result }}" = "success" ]; then
            echo "[OK] At least one deployment succeeded"
          else
            echo "[FAIL] All deployments failed"
            exit 1
          fi

  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.force_deploy != 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Notify deployment failure
        run: |
          echo "## [WARN] Deployment Failed"
          echo ""
          echo "- **Environment**: ${{ inputs.environment || github.event.inputs.environment }}"
          echo "- **Commit**: ${{ github.sha }}"
          echo "- **Failed at**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo ""
          echo "Please check the deployment logs and resolve the issues before retrying."
          echo ""
          echo "To force deployment (not recommended):"
          echo "1. Go to Actions tab"
          echo "2. Re-run the workflow with 'Force deploy' enabled"

      - name: Create rollback record
        run: |
          {
            echo "## [REFRESH] Rollback Record"
            echo ""
            echo "- **Environment**: ${{ inputs.environment || github.event.inputs.environment }}"
            echo "- **Failed Commit**: ${{ github.sha }}"
            echo "- **Rollback Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "- **Rollback Reason**: Deployment validation failed"
          } > rollback-summary.md

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v5
        with:
          name: rollback-${{ github.sha }}
          path: rollback-summary.md
          retention-days: 30
