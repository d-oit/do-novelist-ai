---
name: üöÄ Production CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - "src/**"
      - "tests/**"
      - "vite.config.ts"
      - "package.json"
      - "tsconfig.json"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - "tests/**"
      - "vite.config.ts"
      - "package.json"
      - "tsconfig.json"
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip E2E tests for faster feedback"
        required: false
        type: boolean
        default: false
      performance_mode:
        description: "Enable performance optimizations"
        required: false
        type: boolean
        default: true

concurrency:
  group: production-ci-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: "--max-old-space-size=4096"
  CI: true
  # Performance optimizations
  VITE_BUILD_TARGET: "production"
  PLAYWRIGHT_BROWSERS_PATH: "~/.cache/ms-playwright"

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

jobs:
  # üöÄ Fast pre-flight validation
  validate:
    name: üîç Pre-flight Validation
    runs-on: ubuntu-latest
    timeout-minutes: 3
    outputs:
      should_run_e2e: ${{ steps.validation.outputs.should_run_e2e }}
      environment: ${{ steps.env.outputs.environment }}
      build_cache_key: ${{ steps.cache.outputs.cache-hit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=staging" >> "$GITHUB_OUTPUT"
          else
            echo "environment=development" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate E2E test conditions
        id: validation
        run: |
          if [ "${{ github.event.inputs.skip_tests }}" = "true" ]; then
            echo "should_run_e2e=false" >> "$GITHUB_OUTPUT"
            echo "üö´ E2E tests skipped via workflow input"
          elif [ "${{ github.event_name }}" = "pull_request" ] && \
               [ "${{ contains(github.event.pull_request.labels.*.name, 'skip-e2e') }}" = "true" ]; then
            echo "should_run_e2e=false" >> "$GITHUB_OUTPUT"
            echo "üö´ E2E tests skipped via PR label"
          else
            echo "should_run_e2e=true" >> "$GITHUB_OUTPUT"
            echo "‚úÖ E2E tests will run"
          fi

      - name: Check build cache
        id: cache
        uses: actions/cache@v5
        with:
          path: |
            node_modules/.vite
            dist
          key: ${{ runner.os }}-vite-${{ hashFiles('src/**', 'vite.config.ts', 'package.json') }}
          restore-keys: |
            ${{ runner.os }}-vite-
            ${{ runner.os }}-build-

  # üîí Security scanning (parallel execution)
  security:
    name: üõ°Ô∏è Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci --only=production

      - name: Run security audit
        run: |
          echo "üîç Running security audit..."
          npm audit --audit-level=moderate --json > security-audit.json || true
          npm audit

      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

      - name: Upload security report
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: security-report-${{ github.sha }}
          path: |
            security-audit.json
            codeql/
          retention-days: 30

  # üèóÔ∏è Core build and test pipeline
  core:
    name: üèóÔ∏è Core Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [validate]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache pnpm store
        uses: actions/cache@v5
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Code quality checks
        run: |
          echo "üîç Running code quality checks..."
          pnpm run lint:ci
          pnpm run type-check

      - name: Unit tests
        run: |
          echo "üß™ Running unit tests..."
          pnpm run test --coverage

      - name: Verify coverage
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            echo "üìä Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 80" | bc -l 2>/dev/null || echo "0") )); then
              echo "‚ùå Coverage below 80%: $COVERAGE%"
              exit 1
            fi
            echo "‚úÖ Coverage threshold met: $COVERAGE%"
          fi

      - name: Build application
        run: |
          echo "üèóÔ∏è Building application..."
          pnpm run build

      - name: Verify build
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "‚ùå Build failed: index.html not found"
            exit 1
          fi
          echo "‚úÖ Build completed successfully"

      - name: Generate build manifest
        run: |
          mkdir -p dist
          cat > dist/build-manifest.json << EOF
          {
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}",
            "environment": "${{ needs.validate.outputs.environment }}"
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts-${{ github.sha }}
          path: |
            dist/
            coverage/
          retention-days: 7

  # üé≠ E2E tests with enhanced isolation
  e2e-tests:
    name: üé≠ E2E Tests [Shard ${{ matrix.shard }}/2]
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: [validate, core]
    if: needs.validate.outputs.should_run_e2e == 'true'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 \
            libxss1 libxtst6 libnss3 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libgbm1 libgtk-3-0 libxshmfence1 \
            ca-certificates fonts-liberation wget

      - name: Cache Playwright browsers
        uses: actions/cache@v5
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Run E2E tests
        run: |
          echo "üß™ Running E2E tests for shard ${{ matrix.shard }}/2"

          # Set environment for optimal test execution
          export CI=true
          export NODE_ENV=test
          export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright

          # Run tests with enhanced error handling
          timeout 1800 pnpm exec playwright test \
            --shard=${{ matrix.shard }}/2 \
            --reporter=list,junit,json \
            --output=test-results \
            --max-failures=10 || {
              echo "‚ùå Tests failed or timed out"
              echo "üìä System resources:"
              df -h
              free -h
              echo "üìÅ Playwright cache:"
              ls -la ~/.cache/ms-playwright/ 2>/dev/null || echo "No browser cache found"
              exit 1
            }

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-results-shard-${{ matrix.shard }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  # üìä Performance analysis
  performance:
    name: üìä Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [core]
    if: github.ref == 'refs/heads/main' || github.event.inputs.performance_mode == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Analyze bundle size
        run: |
          echo "üìä Performance Analysis"
          echo "========================"

          # Bundle analysis
          find dist/assets -name "*.js" -exec ls -lah {} \; 2>/dev/null | head -10 || echo "No JS assets found"

          # Size metrics
          TOTAL_SIZE=$(du -sh dist 2>/dev/null | cut -f1 || echo "0")
          echo "üì¶ Total build size: $TOTAL_SIZE"

          CHUNK_COUNT=$(find dist/assets -name "*.js" -type f 2>/dev/null | wc -l || echo "0")
          echo "üìÑ JavaScript chunks: $CHUNK_COUNT"

          # Performance grade calculation
          if [ "$CHUNK_COUNT" -le 5 ] && [ "$TOTAL_SIZE" \< "3M" ]; then
            echo "üèÜ Performance Grade: A+"
          elif [ "$CHUNK_COUNT" -le 10 ] && [ "$TOTAL_SIZE" \< "5M" ]; then
            echo "üèÜ Performance Grade: A"
          else
            echo "‚ö†Ô∏è Performance Grade: B"
          fi

      - name: Upload performance report
        uses: actions/upload-artifact@v5
        with:
          name: performance-report-${{ github.sha }}
          path: performance-report.md
          retention-days: 30

  # üö¶ Deployment readiness gate
  deployment-ready:
    name: üö¶ Deployment Ready
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [validate, security, core, e2e-tests]
    if: |
      always() &&
      (needs.core.result == 'success') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped') &&
      github.ref == 'refs/heads/main'
    steps:
      - name: Verify deployment readiness
        run: |
          echo "‚úÖ All critical checks passed. Ready for deployment."
          echo "üì¶ Build artifacts: Available"
          echo "üõ°Ô∏è Security scan: ${{ needs.security.result }}"
          echo "üß™ E2E tests: ${{ needs.e2e-tests.result }}"
          echo "üèóÔ∏è Build & test: ${{ needs.core.result }}"
          echo "üåç Environment: ${{ needs.validate.outputs.environment }}"

      - name: Create deployment manifest
        run: |
          cat > deployment-ready.json << EOF
          {
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "ready": true,
            "environment": "${{ needs.validate.outputs.environment }}",
            "checks": {
              "security": "${{ needs.security.result }}",
              "core": "${{ needs.core.result }}",
              "e2e": "${{ needs.e2e-tests.result }}"
            }
          }
          EOF

      - name: Upload deployment manifest
        uses: actions/upload-artifact@v5
        with:
          name: deployment-manifest-${{ github.sha }}
          path: deployment-ready.json
          retention-days: 90

  # üìã Comprehensive summary
  summary:
    name: üìã Pipeline Summary
    runs-on: ubuntu-latest
    needs: [validate, security, core, e2e-tests, performance, deployment-ready]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Generate comprehensive summary
        run: |
          {
            echo "# üöÄ Production CI/CD Pipeline Summary"
            echo ""
            echo "**Generated**: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            echo "**Commit**: ${{ github.sha }}"
            echo "**Branch**: ${{ github.ref_name }}"
            echo "**Trigger**: ${{ github.event_name }}"
            echo "**Environment**: ${{ needs.validate.outputs.environment }}"
            echo ""

            echo "## üéØ Job Results"
            echo ""
            echo "| Job | Status | Duration |"
            echo "|-----|--------|----------|"
            echo "| Pre-flight Validation | ${{ needs.validate.result }} | ~3min |"
            echo "| Security Analysis | ${{ needs.security.result }} | ~15min |"
            echo "| Core Build & Test | ${{ needs.core.result }} | ~20min |"
            echo "| E2E Tests | ${{ needs.e2e-tests.result }} | ~30min |"
            echo "| Performance Analysis | ${{ needs.performance.result }} | ~10min |"
            echo "| Deployment Ready | ${{ needs.deployment-ready.result }} | ~2min |"
            echo ""

            # Overall status calculation
            FAILED_JOBS=0
            [ "${{ needs.core.result }}" != "success" ] && FAILED_JOBS=$((FAILED_JOBS + 1))
            [ "${{ needs.security.result }}" = "failure" ] && FAILED_JOBS=$((FAILED_JOBS + 1))
            [ "${{ needs.e2e-tests.result }}" = "failure" ] && FAILED_JOBS=$((FAILED_JOBS + 1))

            if [ "$FAILED_JOBS" -eq 0 ]; then
              echo "## ‚úÖ Overall Status: SUCCESS"
              echo ""
              echo "üéâ **All critical checks passed!** The application is ready for deployment."
              echo ""
              echo "### Key Achievements:"
              echo "- ‚úÖ Code quality maintained"
              echo "- ‚úÖ Security scan passed"
              echo "- ‚úÖ All tests successful"
              echo "- ‚úÖ Performance targets met"
              echo "- ‚úÖ Deployment ready"
            else
              echo "## ‚ùå Overall Status: FAILURE"
              echo ""
              echo "‚ö†Ô∏è **$FAILED_JOBS critical job(s) failed.** Please review the details above."
              echo ""
              echo "### Required Actions:"
              echo "- Review failed job logs"
              echo "- Fix identified issues"
              echo "- Re-run pipeline after fixes"
            fi

            echo ""
            echo "## üìä Pipeline Metrics"
            echo ""
            echo "- **Total Estimated Duration**: ~60-80 minutes"
            echo "- **Parallel Jobs**: 3 (Security, Core, E2E)"
            echo "- **Cache Hit Rate**: Optimized for faster subsequent runs"
            echo "- **Test Coverage**: >80% threshold maintained"
            echo "- **Security Level**: Moderate+ vulnerabilities blocked"
            echo ""

            echo "## üîó Quick Links"
            echo ""
            echo "- [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            if [ -n "${{ github.event.pull_request.number }}" ]; then
              PR_LINK="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"
              echo "- [Pull Request #${{ github.event.pull_request.number }}](${PR_LINK})"
            fi

          } > pipeline-summary.md

      - name: Upload comprehensive summary
        uses: actions/upload-artifact@v5
        with:
          name: pipeline-summary-${{ github.sha }}
          path: pipeline-summary.md
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('pipeline-summary.md')) {
              const summary = fs.readFileSync('pipeline-summary.md', 'utf8');

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: summary
              });
            }

      - name: Set workflow conclusion
        if: always()
        run: |
          if [ "${{ needs.core.result }}" = "success" ] && \
             [ "${{ needs.security.result }}" != "failure" ]; then
            echo "‚úÖ Workflow completed successfully"
          else
            echo "‚ùå Workflow failed - check logs for details"
            exit 1
          fi
