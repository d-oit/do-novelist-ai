---
name: E2E Tests

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      browser:
        description: "Browser to test (chromium, firefox, webkit, all)"
        required: false
        default: "all"
      test_pattern:
        description: "Test pattern (leave empty for all tests)"
        required: false
        default: ""

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: "--max-old-space-size=4096"
  CI: true
  NODE_ENV: test

jobs:
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }} Shard ${{ matrix.shard_index }}/${{ matrix.total_shards }})
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard_index: [0, 1, 2, 3]
        total_shards: [4]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            ${{ runner.os }}-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 \
            libxss1 libxtst6 libnss3 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libgbm1 libgtk-3-0 libxshmfence1 \
            ca-certificates fonts-liberation wget

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ matrix.browser }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-${{ matrix.browser }}-
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}

      - name: Cache Playwright test results
        uses: actions/cache@v4
        with:
          path: test-results/, playwright-report/
          key: ${{ runner.os }}-playwright-results-${{ matrix.browser }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-playwright-results-${{ matrix.browser }}-
            ${{ runner.os }}-playwright-results-

      - name: Run E2E tests
        run: |
          SHARD_NUM=${{ matrix.shard_index }}
          SHARD_NUM=$((SHARD_NUM + 1))
          echo "üé≠ Running E2E tests on ${{ matrix.browser }} - Shard ${SHARD_NUM}/${{ matrix.total_shards }}"

          # Set environment
          export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright

          # Run tests with sharding and retry logic
          # Using 1 worker per shard to avoid resource contention
          pnpm exec playwright test \
            --project=${{ matrix.browser }} \
            --shard=${SHARD_NUM}/${{ matrix.total_shards }} \
            --reporter=list,html,json \
            --retries=2 \
            --timeout=30000 \
            --workers=1

      - name: Upload test results
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: e2e-results-${{ matrix.browser }}-shard-${{ matrix.shard_index }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 7

      - name: Upload test report
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-shard-${{ matrix.shard_index }}-${{ github.sha }}
          path: playwright-report/
          retention-days: 7

  e2e-summary:
    name: üìä E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Generate E2E summary
        run: |
          {
            echo "# üé≠ E2E Test Summary"
            echo ""
            echo "**Commit**: ${{ github.sha }}"
            echo "**Branch**: ${{ github.ref_name }}"
            echo "**Trigger**: ${{ github.event_name }}"
            echo ""
            echo "## üåê Browser Test Results (12 parallel jobs - 4 shards per browser)"
            echo ""
            echo "| Browser | Shards | Status |"
            echo "|---------|--------|--------|"
            echo "| Chromium | 4 | ${{ needs.e2e-tests.result }} |"
            echo "| Firefox | 4 | ${{ needs.e2e-tests.result }} |"
            echo "| WebKit | 4 | ${{ needs.e2e-tests.result }} |"
            echo ""
            echo "## üìä Execution Details"
            echo ""
            echo "- **Total Tests**: 108"
            echo "- **Parallel Jobs**: 12 (4 shards √ó 3 browsers)"
            echo "- **Expected Duration**: ~3-4 minutes"
            echo ""

            if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
              echo "## ‚úÖ Status: ALL TESTS PASSED"
              echo "All E2E tests completed successfully across all browsers and shards!"
            else
              echo "## ‚ùå Status: TESTS FAILED"
              echo "Some E2E tests failed. Please review the test reports."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.e2e-tests.result }}';
            const emoji = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success'
              ? 'All E2E tests passed across Chromium, Firefox, and WebKit!'
              : 'Some E2E tests failed. Please review the test reports.';

            try {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `${emoji} E2E Test Results\n\n${message}\n\nCommit: ${context.sha}`
              });
            } catch (error) {
              console.log('Could not comment on PR (permissions issue):', error.message);
            }
