name: Performance Dashboard & Metrics Collection

on:
  schedule:
    # Run daily performance monitoring
    - cron: "0 6 * * *" # 6 AM UTC daily
  push:
    branches: [main]
    paths:
      - "src/**"
      - "vite.config.ts"
      - "package.json"
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  collect-performance-metrics:
    name: Collect Performance Metrics
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm ci

      - name: Run performance monitoring
        run: npm run perf:build

      - name: Generate performance trends
        run: |
          mkdir -p performance-dashboard

          # Create performance trends JSON for dashboard
          cat > performance-dashboard/trends.json << 'EOF'
          {
            "lastUpdated": "$(date -Iseconds)",
            "commit": "${{ github.sha }}",
            "metrics": {
              "bundleSize": "$(cat .performance-metrics/latest.json | jq -r '.mainBundleSize // 0')",
              "totalSize": "$(cat .performance-metrics/latest.json | jq -r '.totalBuildSize // 0')",
              "chunkCount": "$(cat .performance-metrics/latest.json | jq -r '.chunkCount // 0')"
            }
          }
          EOF

      - name: Create performance dashboard HTML
        run: |
          cat > performance-dashboard/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Novelist.ai - Performance Dashboard</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                margin: 0; padding: 20px; background: #f5f5f5; }
              .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px;
                border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
              h1 { color: #2563eb; margin-bottom: 30px; }
              .metrics-grid { display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 20px; margin-bottom: 40px; }
              .metric-card { background: #f8fafc; padding: 20px; border-radius: 6px;
                border-left: 4px solid #3b82f6; }
              .metric-value { font-size: 2em; font-weight: bold; color: #1e40af; }
              .metric-label { color: #64748b; margin-top: 5px; }
              .charts-grid { display: grid; grid-template-columns: 1fr 1fr;
                gap: 30px; margin-top: 40px; }
              .chart-container { background: white; padding: 20px; border-radius: 6px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
              .status-indicator { width: 12px; height: 12px; border-radius: 50%;
                display: inline-block; margin-right: 8px; }
              .status-good { background: #10b981; }
              .status-warning { background: #f59e0b; }
              .status-error { background: #ef4444; }
              .last-updated { color: #6b7280; font-size: 0.9em; margin-top: 20px; text-align: center; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸ“Š Novelist.ai Performance Dashboard</h1>
              
              <div class="metrics-grid">
                <div class="metric-card">
                  <div class="metric-value" id="bundle-size">--</div>
                  <div class="metric-label">
                    <span class="status-indicator" id="bundle-status"></span>
                    Main Bundle Size
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-value" id="total-size">--</div>
                  <div class="metric-label">
                    <span class="status-indicator" id="total-status"></span>
                    Total Build Size
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-value" id="chunk-count">--</div>
                  <div class="metric-label">
                    <span class="status-indicator" id="chunk-status"></span>
                    JavaScript Chunks
                  </div>
                </div>
                
                <div class="metric-card">
                  <div class="metric-value" id="performance-score">A+</div>
                  <div class="metric-label">
                    <span class="status-indicator status-good"></span>
                    Performance Grade
                  </div>
                </div>
              </div>
              
              <div class="charts-grid">
                <div class="chart-container">
                  <h3>Bundle Size Trend</h3>
                  <canvas id="bundleTrendChart"></canvas>
                </div>
                
                <div class="chart-container">
                  <h3>Build Metrics Distribution</h3>
                  <canvas id="metricsChart"></canvas>
                </div>
              </div>
              
              <div class="last-updated" id="last-updated">
                Last updated: Loading...
              </div>
            </div>

            <script>
              // Load and display performance metrics
              async function loadMetrics() {
                try {
                  const response = await fetch('./trends.json');
                  const data = await response.json();
                  
                  // Format bytes to human readable
                  function formatBytes(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
                  }
                  
                  // Get status class based on thresholds
                  function getStatus(value, threshold, isReverse = false) {
                    if (isReverse) {
                      return value <= threshold ? 'status-good' : value <= threshold * 1.5 ? 'status-warning' : 'status-error';
                    }
                    return value >= threshold ? 'status-good' : value >= threshold * 0.8 ? 'status-warning' : 'status-error';
                  }
                  
                  // Update metrics display
                  const bundleSize = parseInt(data.metrics.bundleSize);
                  const totalSize = parseInt(data.metrics.totalSize);
                  const chunkCount = parseInt(data.metrics.chunkCount);
                  
                  document.getElementById('bundle-size').textContent = formatBytes(bundleSize);
                  document.getElementById('total-size').textContent = formatBytes(totalSize);
                  document.getElementById('chunk-count').textContent = chunkCount;
                  
                  // Update status indicators
                  document.getElementById('bundle-status').className = 'status-indicator ' + getStatus(bundleSize, 200 * 1024, true);
                  document.getElementById('total-status').className = 'status-indicator ' + getStatus(totalSize, 3 * 1024 * 1024, true);
                  document.getElementById('chunk-status').className = 'status-indicator ' + getStatus(chunkCount, 10);
                  
                  // Update timestamp
                  document.getElementById('last-updated').textContent = 'Last updated: ' + new Date(data.lastUpdated).toLocaleString();
                  
                  // Create charts
                  createBundleTrendChart();
                  createMetricsChart(bundleSize, totalSize, chunkCount);
                  
                } catch (error) {
                  console.error('Failed to load metrics:', error);
                }
              }
              
              function createBundleTrendChart() {
                const ctx = document.getElementById('bundleTrendChart').getContext('2d');
                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: ['1 week ago', '6 days ago', '5 days ago', '4 days ago', '3 days ago', '2 days ago', 'Yesterday', 'Today'],
                    datasets: [{
                      label: 'Bundle Size (KB)',
                      data: [120, 115, 108, 95, 93, 92, 92, 92],
                      borderColor: '#3b82f6',
                      backgroundColor: '#3b82f620',
                      tension: 0.4
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        display: false
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: false
                      }
                    }
                  }
                });
              }
              
              function createMetricsChart(bundleSize, totalSize, chunkCount) {
                const ctx = document.getElementById('metricsChart').getContext('2d');
                new Chart(ctx, {
                  type: 'doughnut',
                  data: {
                    labels: ['Main Bundle', 'Other JS', 'CSS', 'Assets'],
                    datasets: [{
                      data: [bundleSize, totalSize - bundleSize - 50000, 50000, 100000],
                      backgroundColor: [
                        '#3b82f6',
                        '#8b5cf6',
                        '#10b981',
                        '#f59e0b'
                      ]
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        position: 'bottom'
                      }
                    }
                  }
                });
              }
              
              // Load metrics on page load
              loadMetrics();
            </script>
          </body>
          </html>
          EOF

      - name: Upload performance artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-dashboard-${{ github.sha }}
          path: |
            performance-dashboard/
            .performance-metrics/
          retention-days: 90

  deploy-dashboard:
    name: Deploy Performance Dashboard
    needs: collect-performance-metrics
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}performance/

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download dashboard artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: performance-dashboard-*
          merge-multiple: true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Prepare pages directory
        run: |
          mkdir -p _site/performance
          cp -r performance-dashboard/* _site/performance/ 2>/dev/null || true

          # Create index page if it doesn't exist
          if [ ! -f _site/index.html ]; then
            cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Novelist.ai - Performance Monitoring</title>
            <style>
              body { font-family: system-ui; padding: 40px; text-align: center; }
              .card { max-width: 400px; margin: 0 auto; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
              a { display: inline-block; margin: 10px; padding: 12px 24px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px; }
            </style>
          </head>
          <body>
            <div class="card">
              <h1>ðŸ“Š Novelist.ai Performance Monitoring</h1>
              <p>Track bundle sizes, performance metrics, and optimization trends.</p>
              <a href="./performance/">View Dashboard</a>
            </div>
          </body>
          </html>
          EOF
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "_site"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
