---
name: Optimized CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  NODE_OPTIONS: "--max-old-space-size=4096"
  CI: true

jobs:
  # Pre-flight validation
  validate:
    name: âœ… Pre-flight Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_run_e2e: ${{ steps.validation.outputs.should_run_e2e }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Validate environment
        id: validation
        run: |
          echo "should_run_e2e=true" >> "$GITHUB_OUTPUT"
          echo "âœ… Validation passed - E2E tests will run"

  # Security scanning (parallel execution)
  security:
    name: ðŸ”’ Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      security-events: write
      actions: read
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Dependency Review
        if: github.event_name == 'pull_request'
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, Unlicense, CC0-1.0

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-and-quality
          config-file: .github/codeql/codeql-config.yml

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  # Main build and test pipeline (parallel)
  build-and-test:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 25
    strategy:
      fail-fast: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Add pnpm to PATH
        run: |
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> "$GITHUB_ENV"

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-
            ${{ runner.os }}-pnpm-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint and type check
        run: pnpm run lint:ci

      - name: Run unit tests
        run: pnpm run test

      - name: Generate coverage
        run: pnpm run coverage

      - name: Check coverage threshold
        run: |
          if [ -f "coverage/coverage-summary.json" ]; then
            COVERAGE=$(node -p "require('./coverage/coverage-summary.json').total.lines.pct")
            echo "Coverage: $COVERAGE%"
            if (( $(echo "$COVERAGE < 80" | bc -l 2>/dev/null || echo "0") )); then
              echo "âŒ Coverage below 80%: $COVERAGE%"
              exit 1
            fi
            echo "âœ… Coverage threshold met: $COVERAGE%"
          else
            echo "âš ï¸ Coverage report not found, skipping threshold check"
          fi

      - name: Cache Vite build
        uses: actions/cache@v4
        with:
          path: |
            node_modules/.vite
            dist
          key: ${{ runner.os }}-vite-${{ hashFiles('src/**', 'vite.config.ts') }}

      - name: Build application
        run: pnpm run build

      - name: Verify build
        run: |
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed: index.html not found"
            exit 1
          fi
          echo "âœ… Build completed successfully"

      - name: Generate build manifest
        run: |
          mkdir -p dist
          cat > dist/build-manifest.json << EOF
          {
            "commit_sha": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "actor": "${{ github.actor }}"
          }
          EOF

      - name: Upload build artifacts
        uses: actions/upload-artifact@v5
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/
          retention-days: 7

  # Optimized E2E tests (simplified sharding)
  e2e-tests:
    name: ðŸ§ª E2E Tests [Shard ${{ matrix.shard }}/2]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [validate, build-and-test]
    if: needs.validate.outputs.should_run_e2e == 'true'
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Add pnpm to PATH
        run: |
          echo "PNPM_HOME=$HOME/.local/share/pnpm" >> "$GITHUB_ENV"
          echo "PATH=$HOME/.local/share/pnpm:$PATH" >> "$GITHUB_ENV"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
            libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 \
            libxss1 libxtst6 libnss3 libatk1.0-0 libatk-bridge2.0-0 \
            libcups2 libdrm2 libgbm1 libgtk-3-0 libxshmfence1 \
            ca-certificates fonts-liberation wget

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium

       - name: Download build artifacts
         uses: actions/download-artifact@v4
         with:
           name: build-artifacts-${{ github.sha }}
           path: dist/

       - name: Create test results directory
         run: mkdir -p test-results

       - name: Run E2E tests
         run: |
           echo "ðŸ§ª Running E2E tests for shard ${{ matrix.shard }}/2"

           # Set environment for Playwright
           export CI=true
           export PLAYWRIGHT_BROWSERS_PATH=~/.cache/ms-playwright
           export NODE_ENV=test

           # Run tests with shard
           timeout 1200 pnpm exec playwright test \
             --shard=${{ matrix.shard }}/2 \
             --reporter=list,junit,json \
             --max-failures=10 || {
               echo "âŒ Tests failed or timed out"
               # Collect debug info
               df -h
               free -h
               ls -la ~/.cache/ms-playwright/ 2>/dev/null || echo "No browser cache"
               exit 1
             }

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: playwright-results-shard-${{ matrix.shard }}-${{ github.sha }}
          path: |
            playwright-report/
            test-results/
          retention-days: 14

  # Performance analysis
  performance:
    name: ðŸ“Š Performance Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-test
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ github.sha }}
          path: dist/

      - name: Analyze bundle size
        run: |
          echo "ðŸ“Š Performance Analysis"
          echo "======================"

          # Analyze bundle
          find dist/assets -name "*.js" -exec ls -lah {} \; 2>/dev/null | head -10 || echo "No JS assets found"

          # Total size
          TOTAL_SIZE=$(du -sh dist 2>/dev/null | cut -f1 || echo "0")
          echo "Total build size: $TOTAL_SIZE"

          # Chunk count
          CHUNK_COUNT=$(find dist/assets -name "*.js" -type f 2>/dev/null | wc -l || echo "0")
          echo "JavaScript chunks: $CHUNK_COUNT"

      - name: Upload performance report
        uses: actions/upload-artifact@v5
        with:
          name: performance-report-${{ github.sha }}
          path: performance-report.md
          retention-days: 30

  # Deployment gate
  deployment-ready:
    name: ðŸš¦ Deployment Ready
    runs-on: ubuntu-latest
    needs: [security, build-and-test, e2e-tests]
    if: |
      always() &&
      (needs.build-and-test.result == 'success') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped') &&
      github.ref == 'refs/heads/main'
    timeout-minutes: 5
    steps:
      - name: Verify deployment readiness
        run: |
          echo "âœ… All checks passed. Ready for deployment."
          echo "Build artifacts: available"
          echo "Security scan: ${{ needs.security.result }}"
          echo "E2E tests: ${{ needs.e2e-tests.result }}"
          echo "Build & test: ${{ needs.build-and-test.result }}"

      - name: Create deployment manifest
        run: |
          cat > deployment-ready.json << EOF
          {
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "ready": true
          }
          EOF

  # Summary and notifications
  summary:
    name: ðŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    needs: [security, build-and-test, performance, deployment-ready]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Generate summary
        run: |
          {
            echo "# ðŸ“‹ CI/CD Pipeline Summary"
            echo ""
            echo "**Commit**: ${{ github.sha }}"
            echo "**Branch**: ${{ github.ref_name }}"
            echo "**Trigger**: ${{ github.event_name }}"
            echo ""
            echo "## ðŸŽ¯ Job Results"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Security | ${{ needs.security.result }} |"
            echo "| Build & Test | ${{ needs.build-and-test.result }} |"
            echo "| Performance | ${{ needs.performance.result }} |"
            echo "| Deployment Ready | ${{ needs.deployment-ready.result }} |"
            echo ""
            
            # Overall status
            FAILED=0
            [ "${{ needs.build-and-test.result }}" != "success" ] && FAILED=$((FAILED + 1))
            [ "${{ needs.security.result }}" = "failure" ] && FAILED=$((FAILED + 1))
            
            if [ "$FAILED" -eq 0 ]; then
              echo "## âœ… Overall Status: SUCCESS"
              echo "All critical checks passed!"
            else
              echo "## âŒ Overall Status: FAILURE"
              echo "$FAILED critical job(s) failed."
            fi
          } > pipeline-summary.md

      - name: Upload summary
        uses: actions/upload-artifact@v5
        with:
          name: pipeline-summary-${{ github.sha }}
          path: pipeline-summary.md
          retention-days: 30
